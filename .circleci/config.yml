# This config was automatically generated from your source code
# Stacks detected: deps:java:web_game,deps:node:web_game_interface/react-typescript,tool:gradle:
version: 2.1

executors:
  java-executor:
    docker:
      - image: gradle:8.13-jdk23
    working_directory: ~/spring-app

jobs:
  test-java:
    executor: java-executor
    steps:
      - checkout:
          path: ~/project

      - run:
          name: Install tools
          command: |
            sudo apt-get update
            sudo apt-get install -y openssh-client netcat

      - add_ssh_keys:
          fingerprints:
            - "SHA256:iT4tPclDaeYtncq3Tu7/Sg6HZskK9BOMPiMxdiCJ11k"

      - run:
          name: Start SSH tunnel to AWS RDS via EC2
          background: true
          command: |
            ssh -o StrictHostKeyChecking=no -i ./web_game/WebGame.pem -N -L 33066:webgamedb.cn7ns9r6pwgg.us-east-1.rds.amazonaws.com:3306 ec2-user@3.236.27.148

      - run:
          name: Wait for tunnel
          command: |
            for i in {1..10}; do
              nc -z localhost 33066 && echo "Tunnel ready" && exit 0
              echo "Waiting for tunnel..."
              sleep 3
            done
            echo "Tunnel failed" && exit 1

      - run:
          name: Make gradlew executable
          command: chmod +x ./gradlew
          
      - run:
          name: Run tests
          command: ./gradlew test -i -Dspring.datasource.url=jdbc:mysql://localhost:33066/yourDatabase

      - store_test_results:
          path: build/test-results
      - store_artifacts:
          path: build/reports

workflows:
  build-and-test:
    jobs:
      - test-java
