# This config was automatically generated from your source code
# Stacks detected: deps:java:web_game,deps:node:web_game_interface/react-typescript,tool:gradle:
version: 2.1

executors:
  java-executor:
    docker:
      - image: gradle:8.13-jdk23
    working_directory: ~/spring-app

jobs:
  test-java:
    executor: java-executor
    steps:
      - checkout:
          path: ~/project

      - run:
          name: Install tools
          command: |
            apt-get update
            apt-get install -y openssh-client netcat-openbsd

      - run:
          name: Write SSH Key from Environment Variable
          command: |
            mkdir -p ~/.ssh
            echo "$BASTION_PRIVATE_KEY" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa

      - run:
          name: Start SSH tunnel to AWS RDS via EC2
          background: true
          command: |
            ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -N -L 33066:webgamedb.cn7ns9r6pwgg.us-east-1.rds.amazonaws.com:3306 ec2-user@3.236.27.148

      - run:
          name: Wait for tunnel
          command: |
            for i in {1..10}; do
              nc -z localhost 33066 && echo "Tunnel ready" && exit 0
              echo "Waiting for tunnel..."
              sleep 3
            done
            echo "Tunnel failed" && exit 1

      - run:
          name: Make gradlew executable
          command: chmod +x ./gradlew
          
      - run:
          name: Run tests
          command: ./gradlew test -i -Dspring.datasource.url=jdbc:mysql://localhost:33066/WebGames

      - store_test_results:
          path: build/test-results
      - store_artifacts:
          path: build/reports

workflows:
  build-and-test:
    jobs:
      - test-java
