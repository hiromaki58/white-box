# This config was automatically generated from your source code
# Stacks detected: deps:java:web_game,deps:node:web_game_interface/react-typescript,tool:gradle:
version: 2.1

executors:
  java-executor:
    docker:
      - image: cimg/openjdk:21.0
    working_directory: ~/spring-app

jobs:
  test:
    executor: java-executor
    steps:
      - checkout

      - run:
          name: Install SSH client
          command: |
            sudo apt-get update
            sudo apt-get install -y openssh-client

      - add_ssh_keys:
          fingerprints:
            - ./web_game/WebGame.pem  # CircleCIに登録した鍵

      - run:
          name: Start SSH tunnel to AWS RDS via EC2
          background: true
          command: |
            ssh -o StrictHostKeyChecking=no -i ./web_game/WebGame.pem -N -L 33066:webgamedb.cn7ns9r6pwgg.us-east-1.rds.amazonaws.com:3306 ec2-user@3.236.27.148

      - run:
          name: Wait for tunnel
          command: |
            for i in {1..10}; do
              nc -z localhost 33066 && echo "Tunnel ready" && exit 0
              echo "Waiting for tunnel..."
              sleep 3
            done
            echo "Tunnel failed" && exit 1

      - run:
          name: Run Spring Boot tests
          command: |
            ./gradlew test -i
