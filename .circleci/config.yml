version: 2.1

executors:
  java-executor:
    docker:
      - image: gradle:8.13-jdk23
    working_directory: ~/project

jobs:
  test-java:
    executor: java-executor
    steps:
      - checkout:
          path: ~/project

      - run:
          name: Install tools
          command: |
            apt-get update
            apt-get install -y openssh-client netcat-openbsd

      - run:
          name: Write SSH Key from Environment Variable
          command: |
            mkdir -p ~/.ssh
            echo "$BASTION_PRIVATE_KEY" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa

      - run:
          name: Start SSH tunnel to AWS RDS via EC2
          background: true
          command: |
            ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa \
              -N -L 127.0.0.1:33066:webgamedb.cn7ns9r6pwgg.us-east-1.rds.amazonaws.com:3306 ec2-user@3.236.27.148

      - run:
          name: Wait for tunnel
          command: |
            for i in {1..20}; do
              nc -z 127.0.0.1 33066 && echo "Tunnel ready" && exit 0
              echo "Waiting for tunnel..."
              sleep 5
            done
            echo "Tunnel failed" && exit 1

      - run:
          name: Make gradlew executable
          command: chmod +x ./web_game/gradlew

      - run:
          name: Run tests
          command: |
            ./web_game/gradlew test \
              --project-dir ./web_game \
              -i \
              -Dspring.datasource.url=jdbc:mysql://127.0.0.1:33066/WebGame \
              -Dspring.datasource.username=admin \
              -Dspring.datasource.password=XW6QcWCj54OQ1YvXd5HV \
              -Dspring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

      - store_test_results:
          path: web_game/build/test-results

      - store_artifacts:
          path: web_game/build/reports

workflows:
  build-and-test:
    jobs:
      - test-java
